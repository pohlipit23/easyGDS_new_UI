<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EasyGDS - Hotel Search</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            light: '#4F46E5', /* Indigo 600 */
                            DEFAULT: '#4338ca', /* Indigo 700 */
                            dark: '#312e81', /* Indigo 900 */
                        }
                    }
                }
            }
        }
    </script>

    <!-- Icons & Datepicker -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <style>
        .form-card {
            transition: all 0.3s ease;
        }

        .form-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        /* Autocomplete List */
        .custom-options,
        .autocomplete-results {
            max-height: 250px;
            overflow-y: auto;
            scrollbar-width: thin;
        }

        .custom-options::-webkit-scrollbar,
        .autocomplete-results::-webkit-scrollbar {
            width: 6px;
        }

        .custom-options::-webkit-scrollbar-thumb,
        .autocomplete-results::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 3px;
        }

        /* Traveler Popover Animation */
        .traveler-popover {
            transition: opacity 0.2s ease, transform 0.2s ease;
            transform-origin: top right;
        }

        .traveler-popover.hidden {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
        }

        .traveler-popover:not(.hidden) {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }
    </style>
</head>

<body class="bg-slate-100 text-slate-800 p-8 flex justify-center items-start min-h-screen">

    <div class="w-full max-w-md">
        <!-- 2. HOTEL FORM -->
        <div class="form-card bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <div class="flex items-center gap-3 mb-6 border-b pb-4">
                <div class="p-2 bg-indigo-100 rounded-lg text-indigo-600"><i data-lucide="bed"></i></div>
                <h2 class="text-xl font-bold text-brand-dark">Hotel</h2>
            </div>

            <form id="form-hotel" class="space-y-4">
                <div class="relative">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Destination</label>
                    <input type="text" id="ht-dest"
                        class="auto-input w-full p-3 bg-slate-50 rounded-lg border focus:border-indigo-500 outline-none"
                        placeholder="City, Hotel, or Place" data-type="place_id">
                </div>

                <div class="space-y-4">
                    <!-- Dates -->
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Dates</label>
                        <input type="text" id="ht-dates" class="w-full p-3 bg-slate-50 rounded-lg border outline-none"
                            placeholder="Checkin - Checkout">
                    </div>

                    <!-- Traveler Selection -->
                    <div class="relative" id="traveler-widget">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Travelers & Rooms</label>

                        <!-- Trigger Box -->
                        <div id="traveler-trigger"
                            class="w-full p-3 bg-slate-50 rounded-lg border cursor-pointer select-none flex justify-between items-center hover:bg-slate-100 transition-colors">
                            <span id="traveler-summary" class="text-sm font-medium">1 Room, 2 Guests</span>
                            <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400"></i>
                        </div>

                        <!-- Dropdown Panel -->
                        <div id="traveler-popover"
                            class="branch-popover hidden absolute top-full right-0 w-80 sm:w-96 bg-white border border-slate-200 rounded-xl shadow-2xl z-30 mt-2 p-4 max-h-[80vh] overflow-y-auto">

                            <div id="rooms-container" class="space-y-6">
                                <!-- Room Items will be injected here -->
                            </div>

                            <div class="mt-6 pt-4 border-t border-slate-100 flex justify-between items-center">
                                <button type="button" id="btn-add-room"
                                    class="text-indigo-600 text-sm font-bold hover:text-indigo-800 flex items-center gap-1">
                                    <i data-lucide="plus-circle" class="w-4 h-4"></i> Add Room
                                </button>
                                <button type="button" id="btn-done-travelers"
                                    class="bg-indigo-600 text-white px-6 py-2 rounded-lg text-sm font-bold hover:bg-indigo-700">
                                    Done
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <button type="button" id="btn-search-hotel"
                    class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg transition-colors">Search
                    Hotels</button>
            </form>
        </div>

        <div class="mt-8 text-center text-sm text-gray-500">
            * API Proxy must be running.<br>
            <span class="text-xs">Results redirect to <a href="https://demo.apps.easygds.com"
                    class="underline hover:text-indigo-600">demo.apps.easygds.com</a></span>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // ================= CONFIGURATION =================
        const API_BASE_URL = '/api';
        const SESSION_ID = 'demo_session_dynamic_123';
        const CONFIG_ID = '4a5c9770-f901-4b96-8673-ecdc5ee49102';

        // ================= UTILITIES =================
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Helper to get default dates (Start + 2 days, End + 5 days) in Y-m-d format
        function getDefaultDates() {
            const start = new Date();
            start.setDate(start.getDate() + 14); // 2 weeks out
            const end = new Date();
            end.setDate(end.getDate() + 17); // 3 days trip

            const fmt = (d) => d.toISOString().split('T')[0];
            return { startStr: fmt(start), endStr: fmt(end) };
        }

        // ================= API CONNECTION =================
        // Fetches locations for Autocomplete
        async function fetchLocations(query, type) {
            let url;

            // 1. AIRPORT SEARCH (Not primary for Hotel, but supported if type changed)
            if (type === 'airport_code') {
                url = new URL(`${API_BASE_URL}/places/cities-with-airports`, window.location.origin);
                url.searchParams.append("search_text", query);
                url.searchParams.append("language_code", "en-US");
            }

            // 2. GENERAL SEARCH (Hotels, Places)
            else {
                url = new URL(`${API_BASE_URL}/places`, window.location.origin);
                url.searchParams.append("search_text", query);
                url.searchParams.append("language_code", "en-US");

                // Params for full coverage
                url.searchParams.append("types", "country,airport,administrative_area_level_4,administrative_area_level_3");
                url.searchParams.append("property_included", "false");
                url.searchParams.append("with_properties", "true");
                url.searchParams.append("has_code", "false");
                url.searchParams.append("per_page", "20");
                url.searchParams.append("page", "1");
            }

            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error("API Request Failed");
                const data = await res.json();

                let results = [];

                if (Array.isArray(data)) {
                    results = data.map(item => ({
                        name: item.name,
                        code: item.code || item.id,
                        type: 'airport_code',
                        id: item.id,
                        city: item.location?.city_code || item.city,
                        country: item.country,
                        icon: '‚úàÔ∏è'
                    }));
                }
                else {
                    // 1. Places
                    const places = (data.places || []).map(p => ({
                        name: p.long_name || p.name,
                        code: p.id,
                        type: 'place_id',
                        id: p.id,
                        city: p.name,
                        country: p.location?.country_code,
                        icon: 'üìç'
                    }));

                    // 2. Properties (Hotels)
                    const props = (data.properties || []).map(p => ({
                        name: p.name,
                        code: p.hotel_id || p.id,
                        type: 'hotel',
                        id: p.id,
                        city: p.city_name || p.city || p.location?.city_name || '',
                        country: p.country_code || p.location?.country_code || '',
                        stars: p.star || 0,
                        icon: 'üè®'
                    }));

                    results = [...places, ...props];
                }

                return results;

            } catch (e) {
                console.warn("API Error:", e);
                return [];
            }
        }

        // ================= UI COMPONENTS =================



        // --- Autocomplete Component ---
        function setupAutocomplete(input) {
            if (!input) return;
            const type = input.dataset.type || 'any';

            const container = document.createElement('div');
            container.className = 'absolute top-full left-0 w-full bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto z-50 hidden mt-1';
            input.parentElement.style.position = 'relative';
            input.parentElement.appendChild(container);

            let debounceTimer;

            input.addEventListener('input', () => {
                const query = input.value;
                if (query.length < 3) {
                    container.classList.add('hidden');
                    return;
                }

                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(async () => {
                    container.innerHTML = '<div class="p-3 text-sm text-gray-400">Loading...</div>';
                    container.classList.remove('hidden');

                    const results = await fetchLocations(query, type);

                    container.innerHTML = '';
                    if (results.length === 0) {
                        container.innerHTML = '<div class="p-3 text-sm text-gray-400">No results found</div>';
                    } else {
                        results.forEach(res => {
                            const item = document.createElement('div');
                            item.className = 'p-2 hover:bg-slate-50 cursor-pointer text-sm flex justify-between items-center';

                            // Determine Icon
                            let icon = res.icon || 'üìç';
                            if (!res.icon) {
                                if (res.type === 'airport_code') icon = '‚úàÔ∏è';
                                if (res.type === 'hotel') icon = 'üè®';
                            }

                            // Star Rating
                            let starStr = '';
                            if (res.stars && res.stars > 0) {
                                starStr = `<span class="text-yellow-500 ml-1 text-xs">‚≠ê ${res.stars}</span>`;
                            }

                            // Location
                            let locStr = [res.city, res.country].filter(Boolean).join(', ');

                            item.innerHTML = `
                                <div class="flex justify-between items-center w-full">
                                    <div class="font-medium text-slate-800 text-sm overflow-hidden text-ellipsis whitespace-nowrap">
                                        ${icon} ${res.name} ${starStr}
                                    </div>
                                    <div class="text-xs text-slate-400 ml-2 whitespace-nowrap">
                                        ${locStr}
                                    </div>
                                </div>
                            `;

                            item.onclick = () => {
                                input.value = res.name;
                                input.dataset.code = res.code;
                                input.dataset.id = res.id;
                                input.dataset.selType = res.type;
                                container.classList.add('hidden');
                            };
                            container.appendChild(item);
                        });
                    }
                }, 400);
            });

            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !container.contains(e.target)) {
                    container.classList.add('hidden');
                }
            });
        }

        // Init Autocompletes
        document.querySelectorAll('.auto-input').forEach(el => setupAutocomplete(el));

        // ================= DATE PICKER =================
        flatpickr('#ht-dates', { mode: "range", dateFormat: "Y-m-d", minDate: "today" });


        // ================= TRAVELER WIDGET LOGIC =================
        const travelerState = [
            { id: 1, adults: 2, children: [], infants: 0 } // Default: 1 Room, 2 Adults
        ];

        const trigger = document.getElementById('traveler-trigger');
        const popover = document.getElementById('traveler-popover');
        const summary = document.getElementById('traveler-summary');
        const roomsContainer = document.getElementById('rooms-container');
        const btnAddRoom = document.getElementById('btn-add-room');
        const btnDone = document.getElementById('btn-done-travelers');

        // Toggle Popover
        trigger.addEventListener('click', (e) => {
            e.stopPropagation();
            const isHidden = popover.classList.contains('hidden');
            // Close others if any (not implemented here, but good practice)
            popover.classList.toggle('hidden');
        });

        // Close when clicking outside
        document.addEventListener('click', (e) => {
            if (!document.getElementById('traveler-widget').contains(e.target)) {
                popover.classList.add('hidden');
            }
        });

        btnDone.addEventListener('click', () => {
            popover.classList.add('hidden');
        });

        // Add Room
        btnAddRoom.addEventListener('click', () => {
            travelerState.push({
                id: Date.now(),
                adults: 1,
                children: [],
                infants: 0
            });
            renderRooms();
            updateSummary();
        });

        function renderRooms() {
            roomsContainer.innerHTML = '';
            travelerState.forEach((room, index) => {
                const roomEl = document.createElement('div');
                roomEl.className = 'w-full';

                // Header (Room # + Remove)
                const header = document.createElement('div');
                header.className = 'flex justify-between items-center mb-3';
                header.innerHTML = `<h3 class="text-sm font-bold text-slate-700">Room ${index + 1}</h3>`;

                if (travelerState.length > 1) {
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'text-xs text-red-500 hover:text-red-700 font-medium';
                    removeBtn.textContent = 'Remove';
                    removeBtn.onclick = (e) => {
                        e.stopPropagation(); // Prevent closing
                        travelerState.splice(index, 1);
                        renderRooms();
                        updateSummary();
                    };
                    header.appendChild(removeBtn);
                }
                roomEl.appendChild(header);

                // Grid for Counters
                const countersDiv = document.createElement('div');
                countersDiv.className = 'grid grid-cols-1 gap-4 p-3 bg-slate-50 rounded-lg';

                // Helper to create counter row
                const createCounter = (label, value, min, onChange) => {
                    const row = document.createElement('div');
                    row.className = 'flex justify-between items-center';

                    const lbl = document.createElement('span');
                    lbl.className = 'text-sm text-slate-600 font-medium';
                    lbl.textContent = label;

                    const controls = document.createElement('div');
                    controls.className = 'flex items-center gap-3 bg-white rounded-md border border-slate-200 p-1';

                    const btnMinus = document.createElement('button');
                    btnMinus.className = 'w-6 h-6 flex items-center justify-center text-slate-500 hover:bg-slate-100 rounded disabled:opacity-30';
                    btnMinus.innerHTML = '<i data-lucide="minus" class="w-3 h-3"></i>';
                    btnMinus.disabled = value <= min;
                    btnMinus.onclick = (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        if (value > min) onChange(value - 1);
                    };

                    const valDisplay = document.createElement('span');
                    valDisplay.className = 'text-sm w-4 text-center font-bold';
                    valDisplay.textContent = value;

                    const btnPlus = document.createElement('button');
                    btnPlus.className = 'w-6 h-6 flex items-center justify-center text-slate-500 hover:bg-slate-100 rounded';
                    btnPlus.innerHTML = '<i data-lucide="plus" class="w-3 h-3"></i>';
                    btnPlus.onclick = (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        onChange(value + 1);
                    };

                    controls.append(btnMinus, valDisplay, btnPlus);
                    row.append(lbl, controls);
                    return row;
                };

                // Adults
                countersDiv.appendChild(createCounter('Adults', room.adults, 1, (v) => {
                    room.adults = v;
                    renderRooms();
                    updateSummary();
                }));

                // Children
                countersDiv.appendChild(createCounter('Children (2-17)', room.children.length, 0, (v) => {
                    // Adjust array size
                    const diff = v - room.children.length;
                    if (diff > 0) {
                        for (let i = 0; i < diff; i++) room.children.push(8); // Default age 8
                    } else {
                        room.children.splice(diff); // Remove from end
                    }
                    renderRooms();
                    updateSummary();
                }));

                // Infants
                countersDiv.appendChild(createCounter('Infants (0-2)', room.infants, 0, (v) => {
                    room.infants = v;
                    renderRooms();
                    updateSummary();
                }));

                roomEl.appendChild(countersDiv);

                // Child Ages (Dynamic)
                if (room.children.length > 0) {
                    const agesDiv = document.createElement('div');
                    agesDiv.className = 'mt-3 grid grid-cols-2 gap-2 animate-fadeIn';

                    room.children.forEach((age, childIdx) => {
                        const wrap = document.createElement('div');
                        wrap.innerHTML = `<label class="block text-xs text-slate-400 mb-1">Child ${childIdx + 1} Age</label>`;

                        const select = document.createElement('select');
                        select.className = 'w-full p-2 text-sm bg-white border border-slate-200 rounded outline-none focus:border-indigo-500';
                        for (let i = 2; i <= 17; i++) {
                            const opt = document.createElement('option');
                            opt.value = i;
                            opt.textContent = i;
                            if (i === age) opt.selected = true;
                            select.appendChild(opt);
                        }
                        select.onchange = (e) => {
                            e.stopPropagation(); // Just in case
                            room.children[childIdx] = parseInt(e.target.value);
                        };

                        wrap.appendChild(select);
                        agesDiv.appendChild(wrap);
                    });

                    roomEl.appendChild(agesDiv);
                }

                roomsContainer.appendChild(roomEl);
            });

            lucide.createIcons();
        }

        function updateSummary() {
            const totalAdults = travelerState.reduce((sum, r) => sum + r.adults, 0);
            const totalKids = travelerState.reduce((sum, r) => sum + r.children.length + r.infants, 0);
            const totalRooms = travelerState.length;

            let text = `${totalRooms} Room${totalRooms > 1 ? 's' : ''}, ${totalAdults + totalKids} Guest${(totalAdults + totalKids) > 1 ? 's' : ''}`;
            summary.textContent = text;
        }

        // Init
        renderRooms();
        updateSummary();
        // Force popover hidden initially (renderRooms might have side effects if not careful, but okay here)
        popover.classList.add('hidden');


        // ================= SUBMIT HANDLER =================
        function go(paramsObj, customPath) {
            let base;
            if (customPath) {
                base = 'https://demo.apps.easygds.com/shopping/' + customPath;
            } else {
                base = 'https://demo.apps.easygds.com/shopping/processes/' + (paramsObj.process || 'flight');
            }

            paramsObj.currency_code = 'USD';
            paramsObj.language_code = 'en-US';
            paramsObj.session_id = SESSION_ID;

            // Updated Params
            paramsObj.office_domain = 'demo.b2c.easygds.com';
            paramsObj.scope_type = 'B2C';
            paramsObj.flight_campaign = '';
            paramsObj.partner_id = '';
            paramsObj.show_crew_booking = 'true';
            paramsObj.is_crew_booking = 'false';

            // Random search_id
            paramsObj.search_id = Array.from(crypto.getRandomValues(new Uint8Array(16)))
                .map(b => b.toString(16).padStart(2, '0')).join('');

            const qs = new URLSearchParams(paramsObj).toString();
            console.log("Submitting to:", base + '?' + qs);
            window.location.href = base + '?' + qs;
        }

        document.getElementById('btn-search-hotel').onclick = () => {
            const dates = document.getElementById('ht-dates').value.split(' to ');
            const def = getDefaultDates();
            const destInput = document.getElementById('ht-dest');

            const selType = destInput.dataset.selType || 'place_id';
            const code = destInput.dataset.code || '2766'; // Default SIN/Generic

            // GENERATE TRAVELERS JSON FROM STATE
            const travelersApi = [];
            travelerState.forEach((room, rIndex) => {
                // Adults
                for (let i = 0; i < room.adults; i++) {
                    travelersApi.push({ type: 'adult', age: 30, room: rIndex + 1 });
                }
                // Children
                room.children.forEach(age => {
                    travelersApi.push({ type: 'child', age: age, room: rIndex + 1 });
                });
                // Infants
                for (let i = 0; i < room.infants; i++) {
                    travelersApi.push({ type: 'infant', age: 1, room: rIndex + 1 });
                }
            });

            if (selType === 'hotel') {
                // Specific Hotel Property
                go({
                    process: 'hotel',
                    place_type: 'hotel',
                    place_id: code,
                    package_id: CONFIG_ID,
                    expectation: JSON.stringify({
                        ht_des_code: code,
                        ht_checkin_date: dates[0] || def.startStr,
                        ht_checkout_date: dates[1] || def.endStr,
                        ht_des_type: 'property_id',
                        is_separate: true
                    }),
                    travelers: JSON.stringify(travelersApi)
                }, `products/hotel/${code}`);
            } else {
                // General Destination
                go({
                    process: 'hotel',
                    place_type: 'administrative_area_level_4', // Fallback
                    place_id: code,
                    package_id: CONFIG_ID,
                    expectation: JSON.stringify({
                        ht_des_code: code,
                        ht_checkin_date: dates[0] || def.startStr,
                        ht_checkout_date: dates[1] || def.endStr,
                        ht_des_type: 'place_id',
                        is_separate: false
                    }),
                    travelers: JSON.stringify(travelersApi)
                });
            }
        };

    </script>
</body>

</html>